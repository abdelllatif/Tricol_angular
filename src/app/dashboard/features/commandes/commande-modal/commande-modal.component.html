<div class="fixed inset-0 bg-black/20 z-40 flex items-center justify-center">
  <div class="bg-white rounded-xl w-full max-w-2xl p-8 shadow-lg relative z-50">
    <button (click)="closeModal()" class="absolute right-4 top-4 text-gray-400 hover:text-gray-600 text-2xl">
      &times;
    </button>
    <h2 class="text-2xl font-bold mb-6">{{ mode === 'create' ? 'Nouvelle Commande' : 'Modifier Commande' }}</h2>
    <form (ngSubmit)="save()" *ngIf="!loading; else loadingTpl">
      <!-- Fournisseur -->
      <div class="mb-4">
        <label class="block font-semibold mb-1">Fournisseur</label>
        <select [(ngModel)]="commande.fournisseur" name="fournisseur" required class="rounded-lg border px-5 py-3 w-full">
          <option [ngValue]="null" disabled>Choisir un fournisseur...</option>
          <option *ngFor="let f of fournisseurs" [ngValue]="f">{{ f.societe }}</option>
        </select>
      </div>

      <!-- Liste Produits -->
      <div>
        <label class="block font-semibold mb-1 mb-2">Produits</label>
        <table class="w-full border mb-2">
          <thead>
          <tr class="bg-gray-100 text-sm">
            <th class="p-2">Produit</th>
            <th class="p-2 w-28">Quantité</th>
            <th class="p-2 w-20">Prix Unitaire</th>
            <th class="p-2 w-24">Total</th>
            <th class="p-2 w-10"></th>
          </tr>
          </thead>
          <tbody>
          <tr *ngFor="let cp of commande.produits; let i = index">
            <td class="p-2">
              <select [(ngModel)]="cp.produit" name="produit{{i}}" required class="rounded-md border w-full" (change)="updateProduit(i)">
                <option [ngValue]="null" disabled>Choisir...</option>
                <option *ngFor="let p of produits" [ngValue]="p">{{p.nom}}</option>
              </select>
            </td>
            <td class="p-2">
              <input type="number" min="1" [(ngModel)]="cp.quantite" name="quantite{{i}}" (input)="updateProduit(i)" required class="rounded-md border w-full px-2">
            </td>
            <td class="p-2">
              <span *ngIf="cp.produit">{{ cp.produit.prixUnitaire | number:'1.2-2' }} MAD</span>
            </td>
            <td class="p-2">
              <span *ngIf="cp.produit">{{ (cp.produit.prixUnitaire * cp.quantite) | number:'1.2-2' }} MAD</span>
            </td>
            <td class="p-2 text-center">
              <button type="button" (click)="removeProduit(i)" class="text-red-600 hover:text-red-800" title="Supprimer">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
          <tr *ngIf="commande.produits.length === 0">
            <td colspan="5" class="p-4 text-center text-gray-400">Aucun produit ajouté</td>
          </tr>
          </tbody>
        </table>
        <button type="button" (click)="addProduit()"
                class="bg-green-100 text-green-700 border border-green-600 px-3 py-2 rounded-lg font-semibold text-xs hover:bg-green-200 transition">
          <i class="fas fa-plus"></i> Ajouter produit
        </button>
      </div>

      <!-- Statut -->
      <div class="mt-4 mb-2 flex gap-4">
        <div>
          <label class="block font-semibold">Statut</label>
          <select [(ngModel)]="commande.statut" name="statut" class="rounded-lg border px-5 py-3 w-44">
            <option value="EN_ATTENTE">En attente</option>
            <option value="VALIDEE">Validée</option>
            <option value="LIVREE">Livrée</option>
            <option value="ANNULEE">Annulée</option>
          </select>
        </div>
        <div class="flex-1 justify-end text-right">
          <span class="font-semibold">Total :</span>
          <span class="ml-1 text-blue-700 text-xl">{{ commande.montantTotal | number:'1.2-2' }} MAD</span>
        </div>
      </div>

      <p *ngIf="error" class="text-red-700 my-2">{{error}}</p>
      <div class="flex justify-end mt-6 gap-4">
        <button type="button" (click)="closeModal()" class="px-6 py-3 bg-gray-200 rounded-xl font-semibold hover:bg-gray-300">Annuler</button>
        <button [disabled]="saving" class="bg-blue-700 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-800 relative">
          <span *ngIf="saving" class="mr-2"><i class="fas fa-spinner fa-spin"></i></span>
          {{ mode === 'create' ? 'Créer' : 'Enregistrer' }}
        </button>
      </div>
    </form>
    <ng-template #loadingTpl>
      <div class="py-8 text-center">Chargement...</div>
    </ng-template>
  </div>
</div>
